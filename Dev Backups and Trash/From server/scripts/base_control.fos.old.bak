//
// FOnline: Aftertimes
// worldremaker
//
// base_control.fos
//

/*
Main scenario:
- Run some terminal (hi repair or science skills required).
- Protect yourself (and your team) from mob's waves.
- Collect reward from container (check the team id of player who started the timer - opener must have the same team id).
- Add scores to player who started the timer.
*/

#include "_defines.fos"
#include "_maps.fos"
#include "_vars.fos"
#include "broadcast_h.fos"
#include "entire.fos"
#include "factions_h.fos"
#include "follower_common_h.fos"
#include "mapdata_h.fos"
#include "npc_common_h.fos"
#include "npc_roles_h.fos"

#define CONTROLLING_TIME                       (12) // in minutes
//#define CONTROLLING_TIME                       (1) // in minutes
#define CONTROLLING_BEST_SCORE_BASE            (44)

// Global script variables
// array<float>     factionInfluence;
// uint             faction;              // Controlling faction.
bool CanTakeWaterworks = true, CanTakeArea51 = true, CanTakeNukaCola = true, CanTakeMariposa = true, CanTakeSierra = true;

// Initialize

/* void InitBaseControl()  // EXPORT (not working yet)
{
	if(!LoadBaseData())
		SaveBaseData();
}
*/

// Set it up by dialog, via computer or other tech device (depends by map)

bool s_Terminal(Critter& player, Scenery& terminal, int skill, Item@ item)
{
    if(!player.IsPlayer() || (skill != -1 && skill != SK_SCIENCE) || valid(item))
        return false;
		
	/* if(player.Stat[SK_SCIENCE] < 100)
	{
		player.Say(SAY_NETMSG, "You don't have any idea how to use this computer machine.");
		return true;
	}
	*/
	
		
	uint faction = player.Stat[ST_TEAM_ID]; // Not factioned yet.
	
	if(faction < 200)
	{
		player.Say(SAY_NETMSG, "You have to belong to some player driven faction.");
		return true;
	}
	
    
	Map@ baseMap = player.GetMap();
	Location@ baseLoc = baseMap.GetLocation();
	uint16 location = baseLoc.GetProtoId();
	uint TakingTime = CONTROLLING_TIME * 60 - player.Skill[SK_SCIENCE];
	//uint TakingTime = CONTROLLING_TIME * 60;
	string locationName, factionname;
	
	GetFactionNameStr(faction, factionname);
	
	switch(location)
	{
		case LOCATION_Waterworks :
			if(!CanTakeWaterworks)
			{
				player.Say(SAY_NETMSG, "You can't start it again.");
				return true;
			}
			locationName = "Waterworks Station";
			CanTakeWaterworks = false;
			break;
		case LOCATION_Area51 :
			if(!CanTakeArea51)
			{
				player.Say(SAY_NETMSG, "You can't start it again.");
				return true;
			}
			locationName = "Area 51 Air Force Facility";
			CanTakeArea51 = false;
			break;
		case LOCATION_SaltLake :
			if(!CanTakeNukaCola)
			{
				player.Say(SAY_NETMSG, "You can't start it again.");
				return true;
			}
			locationName = "Nuka Cola Bottle Plant";
			CanTakeNukaCola = false;
			break;
		case LOCATION_MariposaMilitaryBase :
			if(!CanTakeMariposa)
			{
				player.Say(SAY_NETMSG, "You can't start it again.");
				return true;
			}
			locationName = "Mariposa Military Base";
			CanTakeMariposa = false;
			break;
		case LOCATION_Sierra :
			if(!CanTakeSierra)
			{
				player.Say(SAY_NETMSG, "You can't start it again.");
				return true;
			}
			locationName = "Sierra Army Depot";
			CanTakeSierra = false;
			break;
		default:
			player.Say(SAY_NETMSG, "This is not base control location.");
			return true;
	}
	
	// RunDialog(player, DIALOG_no_dialog_yet, terminal.HexX, terminal.HexY, false);
	
	// Collecting all data
	array<uint> controllingdata = { player.Id, location };
	
	ServerEventCNTSet(factionname + " are trying to get control over " + locationName + ": %COUNTDOWN% left.", location, EVENT_TYPE_BASECONTROL, REAL_SECOND(TakingTime));
	//ServerEventCNTSet(player.Name + " from " + factionname + " has started controlling " + locationName + ": %COUNTDOWN% left.", location, EVENT_TYPE_BASECONTROL, REAL_SECOND(TakingTime));
	// ServerEventCNTSet(player.Name + " is started controlling " + locationName + ": %COUNTDOWN% left.", location, EVENT_TYPE_BASECONTROL, REAL_SECOND(TakingTime));
	CreateTimeEvent(AFTER(REAL_SECOND(TakingTime)), "e_FinishTimer", controllingdata, false);
	
	// Controls that player or his teammates are in taken base.
	CreateTimeEvent(AFTER(REAL_SECOND(1)), "e_CheckPlayers", controllingdata, false);
	
    return true;
}

// Initialize time event, chacking players inside.
uint e_CheckPlayers(array<uint>@ values)
{
	uint location = values[1];
	
	Critter@ player = GetCritter(values[0]);
	if(!valid(player))
	{
		ServerEventCNTStop(location, EVENT_TYPE_BASECONTROL);
		switch(location)
		{
			case LOCATION_Waterworks :
				CanTakeWaterworks = true;
				break;
			case LOCATION_Area51 :
				CanTakeArea51 = true;
				break;
			case LOCATION_SaltLake :
				CanTakeNukaCola = true;
				break;
			case LOCATION_MariposaMilitaryBase :
				CanTakeMariposa = true;
				break;
			case LOCATION_Sierra :
				CanTakeSierra = true;
				break;
		}
		return 0;
	}
	
	
	//Checking location is ready to take. If yes stop then checking players inside.
	switch(location)
	{
		case LOCATION_Waterworks :
			if(CanTakeWaterworks) return 0;
			break;
		case LOCATION_Area51 :
			if(CanTakeArea51) return 0;
			break;
		case LOCATION_SaltLake :
			if(CanTakeNukaCola) return 0;
			break;
		case LOCATION_MariposaMilitaryBase :
			if(CanTakeMariposa) return 0;
			break;
		case LOCATION_Sierra :
			if(CanTakeSierra) return 0;
			break;
	}
	
	// Player left base location
	Map@ baseMap = player.GetMap();
	if(!valid(baseMap))
	{
		player.Say(SAY_NETMSG, "You've left base during taking control.");
		ServerEventCNTStop(location, EVENT_TYPE_BASECONTROL);
		switch(location)
		{
			case LOCATION_Waterworks :
				CanTakeWaterworks = true;
				break;
			case LOCATION_Area51 :
				CanTakeArea51 = true;
				break;
			case LOCATION_SaltLake :
				CanTakeNukaCola = true;
				break;
			case LOCATION_MariposaMilitaryBase :
				CanTakeMariposa = true;
				break;
			case LOCATION_Sierra :
				CanTakeSierra = true;
				break;
		}
		return 0;
	}
	Location@ baseLoc = baseMap.GetLocation();
	if((baseLoc.GetProtoId() != location) || !valid(baseLoc) || player.IsDead())
	{
		if(!player.IsDead())
			player.Say(SAY_NETMSG, "You've left base during taking control.");
		else
			player.Say(SAY_NETMSG, "You've lost base.");
		ServerEventCNTStop(location, EVENT_TYPE_BASECONTROL);
		switch(location)
		{
			case LOCATION_Waterworks :
				CanTakeWaterworks = true;
				break;
			case LOCATION_Area51 :
				CanTakeArea51 = true;
				break;
			case LOCATION_SaltLake :
				CanTakeNukaCola = true;
				break;
			case LOCATION_MariposaMilitaryBase :
				CanTakeMariposa = true;
				break;
			case LOCATION_Sierra :
				CanTakeSierra = true;
				break;
		}
		return 0;
	}
	
	
	return REAL_SECOND(1);
}

// Spawn mobs during taking the control. Entire 220?

// Timer end - take the reward from container and set scores.
uint e_FinishTimer(array<uint>@ values)
{
	Critter@ player = GetCritter(values[0]);
	
	uint location = values[1], faction = player.Stat[ST_TEAM_ID];
	//uint location = values[1];
	uint8 id;
	string factionname;
	
	GetFactionNameStr(faction, factionname);
	
	switch(location)
	{
		case LOCATION_Waterworks :
			id = 1;
			break;
		case LOCATION_Area51 :
			id = 2;
			break;
		case LOCATION_SaltLake :
			id = 3;
			break;
		case LOCATION_MariposaMilitaryBase :
			id = 4;
			break;
		case LOCATION_Sierra :
			id = 5;
			break;
	}
	
	if(!valid(player))
		return 0;
	
	// Player left base location
	Map@ baseMap = player.GetMap();
	Location@ baseLoc = baseMap.GetLocation();
	if(baseLoc.GetProtoId() != location)
		return 0;
	
	// SetBaseControlScore(id); // Not working - factioned mode
	
	// Set scores for player
	// Spawn reward in some container and remove it after one minute. Access to container must belong to player who started the timer or his teammates.
	
	switch(location)
	{
		case LOCATION_Waterworks :
			if(!CanTakeWaterworks)
			{
				//player.AddScore(CONTROLLING_BEST_SCORE_BASE + id, 1);
				SetBestScore(CONTROLLING_BEST_SCORE_BASE + id, null, factionname);
				CanTakeWaterworks = true;
				player.Say(SAY_NETMSG, "Your faction now has control over Waterworks Station.");
			}
			break;
		case LOCATION_Area51 :
			if(!CanTakeArea51)
			{
				//player.AddScore(CONTROLLING_BEST_SCORE_BASE + id, 1);
				SetBestScore(CONTROLLING_BEST_SCORE_BASE + id, null, factionname);
				CanTakeArea51 = true;
				player.Say(SAY_NETMSG, "Your faction now has control over Area 51 Air Force Facility.");
			}
			break;
		case LOCATION_SaltLake :
			if(!CanTakeNukaCola)
			{
				//player.AddScore(CONTROLLING_BEST_SCORE_BASE + id, 1);
				SetBestScore(CONTROLLING_BEST_SCORE_BASE + id, null, factionname);
				CanTakeNukaCola = true;
				player.Say(SAY_NETMSG, "Your faction now has control over Nuka Cola Bottle Plant.");
			}
			break;
		case LOCATION_MariposaMilitaryBase :
			if(!CanTakeMariposa)
			{
				//player.AddScore(CONTROLLING_BEST_SCORE_BASE + id, 1);
				SetBestScore(CONTROLLING_BEST_SCORE_BASE + id, null, factionname);
				CanTakeMariposa = true;
				player.Say(SAY_NETMSG, "Your faction now has control over Mariposa Military Base.");
			}
			break;
		case LOCATION_Sierra :
			if(!CanTakeSierra)
			{
				//player.AddScore(CONTROLLING_BEST_SCORE_BASE + id, 1);
				SetBestScore(CONTROLLING_BEST_SCORE_BASE + id, null, factionname);
				CanTakeSierra = true;
				player.Say(SAY_NETMSG, "Your faction now has control over Sierra Army Depot.");
			}
			break;
	}
	
	return 0;
}

void SpawnReward(Critter& player, Location& baseLoc)
{
	// Get map with proper locker - find via entire 182
	array<Map@> maps;
	baseLoc.GetMaps(maps);
	
	if(!valid(player))
		return;
	
	for(uint i = 0, j = maps.length(); i < j; i++)
	{
		if(valid(maps[i]))
		{
			array<Item@> containers;
			maps[i].GetItemsByType(ITEM_TYPE_CONTAINER, containers);
			uint16 entireX = 0, entireY = 0;
			maps[i].GetEntireCoords(ENTIRE_BASE_CONT_REWARD, 0, entireX, entireY);

			for(uint k = 0, l = containers.length; k < l; k++)
				{
					uint16 containerX = 0, containerY = 0;
					containers[k].GetMapPosition(containerX, containerY);
					if(entireX == containerX && entireY == containerY)
					{
						containers[k].Val5 = player.Stat[ST_TEAM_ID];
						// container[k].AddItem(somestuff cyka);
						array<uint> controllingdata = { containers[k].Id };
						CreateTimeEvent(AFTER(REAL_MINUTE(1)), "e_DeleteReward", controllingdata, false); // For reward spawner
					}
				}
		}
		
	}
	// Get faction id from all players from map
	
}

void RewardSpawner(Item& item, bool firstTime)
{
	item.SetEvent(ITEM_EVENT_SKILL, "_UseRewardSpawner");
}

bool _UseRewardSpawner(Item& spawner, Critter& player, int skill)
{
	// Opening / Closing
    if((skill == -1) || (skill == SK_STEAL))
    {
		if(spawner.Val5 != player.Stat[ST_TEAM_ID])
        {
			player.Say(SAY_NETMSG, "You don't have access to this locker.");
            return true;
        }
		
        // open it if closed
        if(_LockerIsClose(spawner))
        {		
            return false;
        }
    }
    return false;
}

uint e_DeleteReward(array<uint>@ values)
{
	// Get this spawner from array
	Item@ spawner = GetItem(values[0]);
	if(!valid(spawner))
		return 0;
	 
	spawner.Val5 = 0;
	ClearContainer(spawner);
	return 0;
}

/// SETTING BEST SCORES FOR FACTIONS - in preparing
/* float GetInfluence(uint factionId)
    {
        uint len = factionInfluence.length();
        for(uint i = 0; i < len; i += 2)
        {
            if(uint(factionInfluence[i]) == factionId)
                return(factionInfluence[i + 1]);
        }
        return 0.0f;
    }

void SetInfluence(uint factionId, float value)
    {
        uint len = factionInfluence.length();
        bool found;
        for(uint i = 0; i < len; i += 2)
        {
            if(uint(factionInfluence[i]) == factionId)
            {
                DLog("factionId=" + factionId + ",value=" + value);
                DLog("factionInfluence[" + (i + 1) + "]==" + factionInfluence[i + 1]);
                factionInfluence[i + 1] = value;
                factionInfluence[i + 1] = CLAMP(factionInfluence[i + 1], 0.0f, 50000.0f);
                found = true;
            }
        }
        if(found)
            return;

        DLog("inserting " + factionId + " into influence data");
        factionInfluence.insertLast(factionId);
        factionInfluence.insertLast(value);
    }


void ModifyInfluence(uint factionId, float value)
    {
        SetInfluence(factionId, GetInfluence(factionId) + value);
    }

		
void SetBaseControlScore(uint8 id)
{		
		ModifyInfluence(faction,1);
	    string factionname;
        GetFactionNameStr(faction, factionname);
		GameVar@ bestScore = GetGlobalVar(61010+id);
		float bestScoreVar=bestScore.GetValue();
		if(GetInfluence(faction)>bestScoreVar) 
		{
		bestScore+=1;
		if(factionname == "")
        {SetBestScore(CONTROLLING_BEST_SCORE_BASE + id, null, "None");}
		else
		SetBestScore(CONTROLLING_BEST_SCORE_BASE + id, null, factionname);
		}
}


// For later - factioned version
// Saving and loading scores
bool LoadBaseData()
{
	Serializator serializer;
	
	serializer.Clear();
	if(!IsAnyData("BaseControlData"))
		return false;

	if(!serializer.Load("BaseControlData"))
	{
		return false;
	}
	serializer.Get(faction).Get(factionInfluence);
	return true;
}

bool SaveBaseData()
{
	Serializator serializer;
	
    serializer.Clear();
    return serializer.Set(faction).Set(factionInfluence).Save("BaseControlData");
}
*/